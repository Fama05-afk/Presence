<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Bordeaux - Suivi de Pr√©sence - Goudi Aljuma</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        body.night-mode {
            background: #1F2937;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* PAGE DE CONNEXION */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            padding: 50px;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 450px;
            width: 100%;
            border: 3px solid #F59E0B;
        }
        
        .login-title {
            font-size: 32px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 12px;
        }
        
        .login-subtitle {
            font-size: 18px;
            color: #F59E0B;
            margin-bottom: 32px;
        }
        
        .login-input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #F59E0B;
        }
        
        .login-btn {
            width: 100%;
            padding: 16px;
            background: #1E3A8A;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }
        
        .login-error {
            background: #FEE2E2;
            color: #DC2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #DC2626;
        }
        
        /* HEADER */
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid #F59E0B;
        }
        
        body.night-mode .header {
            background: #374151;
            color: white;
        }
        
        .logo-title {
            font-size: 36px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 8px;
        }
        
        body.night-mode .logo-title {
            color: #F59E0B;
        }
        
        .subtitle {
            font-size: 18px;
            color: #F59E0B;
            font-style: italic;
        }
        
        body.night-mode .subtitle {
            color: #FCD34D;
        }
        
        /* CONTROLS */
        .controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #1E3A8A;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }
        
        .control-btn.logout {
            background: #DC2626;
        }
        
        .control-btn.logout:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }
        
        .control-btn.alert {
            background: #F59E0B;
        }
        
        .control-btn.alert:hover {
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* STATS */
        .stats-container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 2px solid #1E3A8A;
        }
        
        body.night-mode .stats-container {
            background: #374151;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .stat-card {
            background: #F3F4F6;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        body.night-mode .stat-card {
            background: #4B5563;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1E3A8A;
        }
        
        body.night-mode .stat-number {
            color: #F59E0B;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6B7280;
            margin-top: 4px;
        }
        
        body.night-mode .stat-label {
            color: #D1D5DB;
        }
        
        /* TABLEAU */
        .table-container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 2px solid #F59E0B;
            overflow-x: auto;
        }
        
        body.night-mode .table-container {
            background: #374151;
        }
        
        .presence-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .presence-table th {
            background: #1E3A8A;
            color: white;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #1E3A8A;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: bold;
        }
        
        .presence-table th.name-column {
            text-align: left;
            min-width: 180px;
        }
        
        .presence-table th.date-column {
            min-width: 50px;
            font-size: 11px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 8px 4px;
        }
        
        .presence-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #E5E7EB;
        }
        
        body.night-mode .presence-table td {
            border-color: #4B5563;
            color: white;
        }
        
        .presence-table td.name-cell {
            text-align: left;
            font-weight: 600;
            color: #1E3A8A;
            background: #F9FAFB;
        }
        
        body.night-mode .presence-table td.name-cell {
            color: #F59E0B;
            background: #4B5563;
        }
        
        .presence-table tr.alert-row {
            background: #FEF2F2;
        }
        
        body.night-mode .presence-table tr.alert-row {
            background: #7F1D1D;
        }
        
        .presence-table tr.alert-row td.name-cell {
            background: #FEE2E2;
            color: #DC2626;
            font-weight: bold;
        }
        
        body.night-mode .presence-table tr.alert-row td.name-cell {
            background: #991B1B;
            color: #FCA5A5;
        }
        
        .presence-cell {
            cursor: pointer;
            padding: 8px;
            transition: all 0.2s;
            font-weight: bold;
            border-radius: 4px;
        }
        
        .presence-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .presence-cell.present {
            background: #10B981;
            color: white;
        }
        
        .presence-cell.absent {
            background: #DC2626;
            color: white;
        }
        
        .presence-cell.empty {
            background: #F3F4F6;
            color: #9CA3AF;
        }
        
        body.night-mode .presence-cell.empty {
            background: #4B5563;
            color: #6B7280;
        }
        
        .alert-badge {
            background: #DC2626;
            color: white;
            padding: 2px 8px;
            border-radius: 50px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        /* NIGHT MODE TOGGLE */
        .night-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1E3A8A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .night-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 3px solid #DC2626;
        }
        
        body.night-mode .modal-content {
            background: #374151;
        }
        
        .modal-title {
            font-size: 28px;
            font-weight: bold;
            color: #DC2626;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .alert-item {
            background: #FEF2F2;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid #DC2626;
        }
        
        body.night-mode .alert-item {
            background: #7F1D1D;
        }
        
        .alert-item-name {
            font-weight: bold;
            color: #1E3A8A;
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        body.night-mode .alert-item-name {
            color: #F59E0B;
        }
        
        .alert-item-count {
            color: #DC2626;
            font-weight: bold;
        }
        
        .modal-close-btn {
            width: 100%;
            padding: 14px;
            background: #1E3A8A;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .modal-close-btn:hover {
            background: #2563EB;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .presence-table {
                font-size: 12px;
            }
            
            .presence-table th,
            .presence-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-title">Section Bordeaux</div>
            <div class="login-subtitle">Suivi de Pr√©sence - Goudi Aljuma</div>
            <div id="loginError" class="login-error hidden">
                ‚ùå Mot de passe incorrect
            </div>
            <input 
                type="password" 
                id="passwordInput" 
                class="login-input" 
                placeholder="Mot de passe"
                onkeypress="if(event.key==='Enter') checkPassword()"
            >
            <button class="login-btn" onclick="checkPassword()">
                Se connecter
            </button>
            <div style="margin-top: 16px; text-align: center;">
                <a href="mailto:famadiallodf@gmail.com?subject=R√©initialisation%20mot%20de%20passe%20Section%20Bordeaux&body=Bonjour,%0D%0A%0D%0AJe%20souhaite%20r√©initialiser%20mon%20mot%20de%20passe%20pour%20le%20syst√®me%20de%20suivi%20de%20pr√©sence.%0D%0A%0D%0AMerci." 
                   style="color: #1E3A8A; text-decoration: none; font-size: 14px; font-weight: 600;">
                    üìß Mot de passe oubli√© ?
                </a>
            </div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="mainApp" class="hidden">
        <button class="night-mode-toggle" onclick="toggleNightMode()">üåô Mode Nuit</button>
        
        <div class="header">
            <div class="logo-title">Section Bordeaux</div>
            <div class="subtitle">Suivi de Pr√©sence - Goudi Aljuma</div>
        </div>
        
        <div class="controls">
            <button class="control-btn alert" onclick="showAlerts()">
                ‚ö†Ô∏è Voir les Alertes (<span id="alertCountBtn">0</span>)
            </button>
            <button class="control-btn" onclick="showMemberManagement()">
                üë• G√©rer les Membres
            </button>
            <button class="control-btn" onclick="exportData()">
                üíæ Exporter les Donn√©es
            </button>
            <button class="control-btn" onclick="showPasswordChange()">
                üîë Changer le Mot de Passe
            </button>
            <button class="control-btn logout" onclick="logout()">
                üö™ D√©connexion
            </button>
        </div>
        
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMembers">42</div>
                    <div class="stat-label">Membres</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDates">0</div>
                    <div class="stat-label">S√©ances (Jeudis)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="alertCount">0</div>
                    <div class="stat-label">Alertes Actives</div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="presence-table" id="presenceTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- MODAL ALERTES -->
    <div id="alertModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">‚ö†Ô∏è Alertes: 5+ Absences Cons√©cutives</div>
            <div id="alertList"></div>
            <button class="modal-close-btn" onclick="closeModal()">Fermer</button>
        </div>
    </div>

    <!-- MODAL CHANGEMENT MOT DE PASSE -->
    <div id="passwordModal" class="modal-overlay hidden" onclick="closePasswordModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" style="color: #1E3A8A;">üîë Changer le Mot de Passe</div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #1E3A8A;">
                    Mot de passe actuel :
                </label>
                <input 
                    type="password" 
                    id="currentPassword" 
                    class="login-input"
                    style="margin-bottom: 16px;"
                    placeholder="Entrez le mot de passe actuel"
                >
                
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #1E3A8A;">
                    Nouveau mot de passe :
                </label>
                <input 
                    type="password" 
                    id="newPassword" 
                    class="login-input"
                    style="margin-bottom: 16px;"
                    placeholder="Entrez le nouveau mot de passe"
                >
                
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #1E3A8A;">
                    Confirmer le nouveau mot de passe :
                </label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    class="login-input"
                    placeholder="Confirmez le nouveau mot de passe"
                >
            </div>
            
            <div id="passwordError" class="login-error hidden"></div>
            <div id="passwordSuccess" class="hidden" style="background: #D1FAE5; color: #065F46; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #065F46;">
                ‚úÖ Mot de passe modifi√© avec succ√®s !
            </div>
            
            <button class="modal-close-btn" onclick="changePassword()" style="margin-bottom: 12px;">
                Modifier le Mot de Passe
            </button>
            <button class="modal-close-btn" onclick="closePasswordModal()" style="background: #6B7280;">
                Annuler
            </button>
            
            <div style="margin-top: 20px; padding: 16px; background: #FEF3C7; border-radius: 8px; border: 1px solid #F59E0B;">
                <p style="font-size: 14px; color: #92400E; margin-bottom: 8px;">
                    <strong>üí° Astuce :</strong> Notez votre nouveau mot de passe dans un endroit s√ªr.
                </p>
                <p style="font-size: 14px; color: #92400E; margin-bottom: 8px;">
                    <strong>üìß Mot de passe oubli√© ?</strong>
                </p>
                <a href="mailto:famadiallodf@gmail.com?subject=R√©initialisation%20mot%20de%20passe%20Section%20Bordeaux&body=Bonjour,%0D%0A%0D%0AJe%20souhaite%20r√©initialiser%20mon%20mot%20de%20passe%20pour%20le%20syst√®me%20de%20suivi%20de%20pr√©sence.%0D%0A%0D%0AMerci." 
                   style="display: inline-block; padding: 8px 16px; background: #1E3A8A; color: white; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: bold;">
                    üìß Envoyer une demande de r√©initialisation
                </a>
            </div>
        </div>
    </div>

    <!-- MODAL GESTION DES MEMBRES -->
    <div id="memberModal" class="modal-overlay hidden" onclick="closeMemberModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" style="color: #1E3A8A;">üë• G√©rer les Membres</div>
            
            <!-- Ajouter un membre -->
            <div style="background: #F3F4F6; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                <h3 style="color: #1E3A8A; margin-bottom: 16px; font-size: 18px;">‚ûï Ajouter un Membre</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #1E3A8A; font-size: 14px;">
                            Pr√©nom :
                        </label>
                        <input 
                            type="text" 
                            id="newMemberPrenom" 
                            class="login-input"
                            style="margin-bottom: 0;"
                            placeholder="Pr√©nom"
                        >
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #1E3A8A; font-size: 14px;">
                            Nom :
                        </label>
                        <input 
                            type="text" 
                            id="newMemberNom" 
                            class="login-input"
                            style="margin-bottom: 0;"
                            placeholder="Nom"
                        >
                    </div>
                </div>
                <button class="modal-close-btn" onclick="addMember()" style="background: #10B981; margin-bottom: 0;">
                    ‚ûï Ajouter ce Membre
                </button>
            </div>
            
            <div id="memberError" class="login-error hidden"></div>
            <div id="memberSuccess" class="hidden" style="background: #D1FAE5; color: #065F46; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #065F46;">
                ‚úÖ Op√©ration r√©ussie !
            </div>
            
            <!-- Liste des membres -->
            <div style="background: #F3F4F6; padding: 20px; border-radius: 12px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                <h3 style="color: #1E3A8A; margin-bottom: 16px; font-size: 18px;">üìã Liste des Membres</h3>
                <div id="memberList"></div>
            </div>
            
            <button class="modal-close-btn" onclick="closeMemberModal()" style="background: #6B7280;">
                Fermer
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const defaultMembres = [
            {prenom: "Mariama", nom: "Barry"},
            {prenom: "Bathie", nom: "Diallo"},
            {prenom: "Fadiama", nom: "Diallo"},
            {prenom: "Fama", nom: "Diallo"},
            {prenom: "Mao", nom: "Diop"},
            {prenom: "Mouhamed Lamine", nom: "Diop"},
            {prenom: "Astou", nom: "Fall"},
            {prenom: "Ndeye Absa", nom: "Fall"},
            {prenom: "Arona", nom: "Fall"},
            {prenom: "Mariama", nom: "Gassama"},
            {prenom: "Cheikh Tidiane", nom: "Gaye"},
            {prenom: "Mbaye Niang", nom: "Gaye"},
            {prenom: "Serigne Moustapha", nom: "Gueye"},
            {prenom: "A√Øssatou", nom: "K√©b√©"},
            {prenom: "Tidiane", nom: "K√©b√©"},
            {prenom: "Ndat√©", nom: "L√¥"},
            {prenom: "Diarra", nom: "L√¥"},
            {prenom: "Ndiaya", nom: "L√¥"},
            {prenom: "Khadija", nom: "Mbodj"},
            {prenom: "Rokhaya", nom: "Mbodj"},
            {prenom: "Souleymane", nom: "Mbodj"},
            {prenom: "Sophie", nom: "Mbodji"},
            {prenom: "Mame Cheikh Tidiane", nom: "Ndoye"},
            {prenom: "Ndeye Diop", nom: "Ndiaye"},
            {prenom: "Aly", nom: "Ndiaye"},
            {prenom: "Moussa", nom: "Nguirane"},
            {prenom: "Maodo", nom: "Niang"},
            {prenom: "Khalifa Babacar", nom: "Niang"},
            {prenom: "A√Øda Mb√®ne", nom: "Samb"},
            {prenom: "Ass", nom: "Samb"},
            {prenom: "Assane", nom: "Samb"},
            {prenom: "Bara", nom: "Samb"},
            {prenom: "Madiele", nom: "Samb"},
            {prenom: "Mame Saer", nom: "Samb"},
            {prenom: "Mame Dame", nom: "Samb"},
            {prenom: "Mar√®me", nom: "Samba"},
            {prenom: "Mame Moussa", nom: "Sarr"},
            {prenom: "Fatou", nom: "Seck"},
            {prenom: "Ass", nom: "Seye"},
            {prenom: "Sidy", nom: "Soumar√©"},
            {prenom: "Mouhamed", nom: "Thiam"},
            {prenom: "Ibrahima", nom: "Wade"}
        ];
        
        let membres = [];
        
        function loadMembres() {
            const saved = localStorage.getItem('daaraMembres');
            if (saved) {
                membres = JSON.parse(saved);
            } else {
                membres = [...defaultMembres];
                saveMembres();
            }
        }
        
        function saveMembres() {
            localStorage.setItem('daaraMembres', JSON.stringify(membres));
        }
        
        // G√©n√©rer tous les jeudis de 2026
        function generateThursdayDates() {
            const dates = [];
            const startDate = new Date(2026, 0, 1);
            const endDate = new Date(2026, 11, 31);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const day = d.getDay();
                if (day === 4) { // 4 = jeudi
                    dates.push(new Date(d));
                }
            }
            return dates;
        }
        
        const weekendDates = generateThursdayDates();
        
        // ==========================================
        // SYST√àME DE CONNEXION
        // ==========================================
        
        const correctPasswordHash = "a1dd395c19f3a1f7ff0e6bfe3ee6028e4373b41085a6da776ab02a8baf129abb";
        
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        async function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const inputHash = await hashPassword(input);
            
            // Utiliser le mot de passe personnalis√© s'il existe, sinon utiliser le mot de passe par d√©faut
            const savedHash = localStorage.getItem('daaraPasswordHash') || correctPasswordHash;
            
            if (inputHash === savedHash) {
                localStorage.setItem('daaraAuth', 'true');
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('loginError').classList.add('hidden');
                initApp();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        function logout() {
            localStorage.removeItem('daaraAuth');
            location.reload();
        }
        
        function checkAuth() {
            const isAuth = localStorage.getItem('daaraAuth');
            if (isAuth === 'true') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initApp();
            }
        }
        
        // ==========================================
        // GESTION DES PR√âSENCES
        // ==========================================
        
        let presenceData = {};
        
        function loadPresenceData() {
            const saved = localStorage.getItem('daaraPresences');
            if (saved) {
                presenceData = JSON.parse(saved);
            }
            
            // Initialiser les donn√©es pour les nouveaux membres qui n'ont pas de donn√©es
            membres.forEach((membre, idx) => {
                const key = `${membre.prenom}_${membre.nom}_${idx}`;
                if (!presenceData[key]) {
                    presenceData[key] = {};
                }
            });
        }
        
        function savePresenceData() {
            localStorage.setItem('daaraPresences', JSON.stringify(presenceData));
            updateStats();
        }
        
        function togglePresence(memberKey, dateStr) {
            if (!presenceData[memberKey]) {
                presenceData[memberKey] = {};
            }
            
            const current = presenceData[memberKey][dateStr];
            
            if (!current) {
                presenceData[memberKey][dateStr] = 'P';
            } else if (current === 'P') {
                presenceData[memberKey][dateStr] = 'A';
            } else {
                delete presenceData[memberKey][dateStr];
            }
            
            savePresenceData();
            renderTable();
        }
        
        function getConsecutiveAbsences(memberKey) {
            let maxConsecutive = 0;
            let currentConsecutive = 0;
            
            weekendDates.forEach(date => {
                const dateStr = formatDate(date);
                const status = presenceData[memberKey]?.[dateStr];
                
                if (status === 'A') {
                    currentConsecutive++;
                    maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                } else if (status === 'P') {
                    currentConsecutive = 0;
                }
            });
            
            return maxConsecutive;
        }
        
        function formatDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        }
        
        // ==========================================
        // INTERFACE - TABLEAU
        // ==========================================
        
        function renderTable() {
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            // En-t√™te
            header.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            const nameHeader = document.createElement('th');
            nameHeader.className = 'name-column';
            nameHeader.textContent = 'Membre';
            headerRow.appendChild(nameHeader);
            
            weekendDates.forEach(date => {
                const th = document.createElement('th');
                th.className = 'date-column';
                th.textContent = formatDate(date);
                headerRow.appendChild(th);
            });
            
            header.appendChild(headerRow);
            
            // Corps du tableau
            body.innerHTML = '';
            
            membres.forEach((membre, idx) => {
                const memberKey = `${membre.prenom}_${membre.nom}_${idx}`;
                const consecutiveAbsences = getConsecutiveAbsences(memberKey);
                const hasAlert = consecutiveAbsences >= 5;
                
                const row = document.createElement('tr');
                if (hasAlert) {
                    row.className = 'alert-row';
                }
                
                const nameCell = document.createElement('td');
                nameCell.className = 'name-cell';
                nameCell.innerHTML = `${membre.prenom} ${membre.nom}`;
                if (hasAlert) {
                    nameCell.innerHTML += `<span class="alert-badge">‚ö†Ô∏è ${consecutiveAbsences}</span>`;
                }
                row.appendChild(nameCell);
                
                weekendDates.forEach(date => {
                    const dateStr = formatDate(date);
                    const status = presenceData[memberKey]?.[dateStr];
                    
                    const td = document.createElement('td');
                    const cell = document.createElement('div');
                    cell.className = `presence-cell ${status === 'P' ? 'present' : status === 'A' ? 'absent' : 'empty'}`;
                    cell.textContent = status || '‚Äî';
                    cell.onclick = () => togglePresence(memberKey, dateStr);
                    
                    td.appendChild(cell);
                    row.appendChild(td);
                });
                
                body.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('totalMembers').textContent = membres.length;
            document.getElementById('totalDates').textContent = weekendDates.length;
            
            let alertCount = 0;
            membres.forEach((membre, idx) => {
                const memberKey = `${membre.prenom}_${membre.nom}_${idx}`;
                if (getConsecutiveAbsences(memberKey) >= 5) {
                    alertCount++;
                }
            });
            
            document.getElementById('alertCount').textContent = alertCount;
            document.getElementById('alertCountBtn').textContent = alertCount;
        }
        
        function showAlerts() {
            const alertList = document.getElementById('alertList');
            alertList.innerHTML = '';
            
            let hasAlerts = false;
            
            membres.forEach((membre, idx) => {
                const memberKey = `${membre.prenom}_${membre.nom}_${idx}`;
                const consecutiveAbsences = getConsecutiveAbsences(memberKey);
                
                if (consecutiveAbsences >= 5) {
                    hasAlerts = true;
                    const item = document.createElement('div');
                    item.className = 'alert-item';
                    item.innerHTML = `
                        <div class="alert-item-name">${membre.prenom} ${membre.nom}</div>
                        <div class="alert-item-count">‚ö†Ô∏è ${consecutiveAbsences} absences cons√©cutives</div>
                    `;
                    alertList.appendChild(item);
                }
            });
            
            if (!hasAlerts) {
                alertList.innerHTML = '<div style="text-align:center; color:#10B981; font-weight:bold; padding:20px;">‚úÖ Aucune alerte active</div>';
            }
            
            document.getElementById('alertModal').classList.remove('hidden');
        }
        
        function closeModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('alertModal').classList.add('hidden');
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(presenceData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `daara_presences_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
        
        // ==========================================
        // MODE NUIT
        // ==========================================
        
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            const isNightMode = document.body.classList.contains('night-mode');
            localStorage.setItem('daaraNightMode', isNightMode);
            
            const btn = document.querySelector('.night-mode-toggle');
            btn.textContent = isNightMode ? '‚òÄÔ∏è Mode Jour' : 'üåô Mode Nuit';
        }
        
        function loadNightMode() {
            const isNightMode = localStorage.getItem('daaraNightMode') === 'true';
            if (isNightMode) {
                document.body.classList.add('night-mode');
                document.querySelector('.night-mode-toggle').textContent = '‚òÄÔ∏è Mode Jour';
            }
        }
        
        // ==========================================
        // GESTION DES MEMBRES
        // ==========================================
        
        function showMemberManagement() {
            document.getElementById('memberModal').classList.remove('hidden');
            document.getElementById('newMemberPrenom').value = '';
            document.getElementById('newMemberNom').value = '';
            document.getElementById('memberError').classList.add('hidden');
            document.getElementById('memberSuccess').classList.add('hidden');
            renderMemberList();
        }
        
        function closeMemberModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('memberModal').classList.add('hidden');
            }
        }
        
        function addMember() {
            const prenom = document.getElementById('newMemberPrenom').value.trim();
            const nom = document.getElementById('newMemberNom').value.trim();
            
            const errorDiv = document.getElementById('memberError');
            const successDiv = document.getElementById('memberSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validation
            if (!prenom || !nom) {
                errorDiv.textContent = '‚ùå Le pr√©nom et le nom sont obligatoires';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // V√©rifier si le membre existe d√©j√†
            const exists = membres.some(m => 
                m.prenom.toLowerCase() === prenom.toLowerCase() && 
                m.nom.toLowerCase() === nom.toLowerCase()
            );
            
            if (exists) {
                errorDiv.textContent = '‚ùå Ce membre existe d√©j√†';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Ajouter le membre
            membres.push({prenom, nom});
            saveMembres();
            
            // Initialiser les donn√©es de pr√©sence pour ce membre
            const idx = membres.length - 1;
            const memberKey = `${prenom}_${nom}_${idx}`;
            presenceData[memberKey] = {};
            savePresenceData();
            
            // Afficher le succ√®s
            successDiv.textContent = `‚úÖ ${prenom} ${nom} a √©t√© ajout√© avec succ√®s !`;
            successDiv.classList.remove('hidden');
            
            // R√©initialiser les champs
            document.getElementById('newMemberPrenom').value = '';
            document.getElementById('newMemberNom').value = '';
            
            // Mettre √† jour l'affichage
            renderMemberList();
            renderTable();
            updateStats();
        }
        
        function deleteMember(index) {
            const membre = membres[index];
            
            if (!confirm(`Voulez-vous vraiment supprimer ${membre.prenom} ${membre.nom} ?\n\nAttention : Toutes les donn√©es de pr√©sence seront perdues.`)) {
                return;
            }
            
            // Supprimer les donn√©es de pr√©sence
            const memberKey = `${membre.prenom}_${membre.nom}_${index}`;
            delete presenceData[memberKey];
            
            // Supprimer le membre
            membres.splice(index, 1);
            
            // Reconstruire les cl√©s de pr√©sence pour maintenir la coh√©rence des indices
            const newPresenceData = {};
            membres.forEach((m, idx) => {
                const oldKey = `${m.prenom}_${m.nom}_${idx > index ? idx + 1 : idx}`;
                const newKey = `${m.prenom}_${m.nom}_${idx}`;
                newPresenceData[newKey] = presenceData[oldKey] || {};
            });
            presenceData = newPresenceData;
            
            // Sauvegarder
            saveMembres();
            savePresenceData();
            
            // Afficher le succ√®s
            const successDiv = document.getElementById('memberSuccess');
            successDiv.textContent = `‚úÖ ${membre.prenom} ${membre.nom} a √©t√© supprim√©`;
            successDiv.classList.remove('hidden');
            
            // Mettre √† jour l'affichage
            renderMemberList();
            renderTable();
            updateStats();
        }
        
        function renderMemberList() {
            const list = document.getElementById('memberList');
            list.innerHTML = '';
            
            if (membres.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#6B7280; padding:20px;">Aucun membre</div>';
                return;
            }
            
            membres.forEach((membre, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 2px solid #E5E7EB;';
                
                item.innerHTML = `
                    <div style="font-weight: 600; color: #1E3A8A;">
                        ${membre.prenom} ${membre.nom}
                    </div>
                    <button 
                        onclick="deleteMember(${index})"
                        style="background: #DC2626; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;"
                        onmouseover="this.style.background='#B91C1C'"
                        onmouseout="this.style.background='#DC2626'"
                    >
                        üóëÔ∏è Supprimer
                    </button>
                `;
                
                list.appendChild(item);
            });
        }
        
        // ==========================================
        // CHANGEMENT DE MOT DE PASSE
        // ==========================================
        
        function showPasswordChange() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
        }
        
        function closePasswordModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('passwordModal').classList.add('hidden');
            }
        }
        
        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // V√©rifications
            if (!currentPwd || !newPwd || !confirmPwd) {
                errorDiv.textContent = '‚ùå Tous les champs sont obligatoires';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // V√©rifier l'ancien mot de passe
            const currentHash = await hashPassword(currentPwd);
            const savedHash = localStorage.getItem('daaraPasswordHash') || correctPasswordHash;
            
            if (currentHash !== savedHash) {
                errorDiv.textContent = '‚ùå Le mot de passe actuel est incorrect';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // V√©rifier que les nouveaux mots de passe correspondent
            if (newPwd !== confirmPwd) {
                errorDiv.textContent = '‚ùå Les nouveaux mots de passe ne correspondent pas';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // V√©rifier la longueur minimale
            if (newPwd.length < 4) {
                errorDiv.textContent = '‚ùå Le mot de passe doit contenir au moins 4 caract√®res';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Enregistrer le nouveau mot de passe
            const newHash = await hashPassword(newPwd);
            localStorage.setItem('daaraPasswordHash', newHash);
            
            // Afficher le succ√®s
            successDiv.classList.remove('hidden');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Fermer automatiquement apr√®s 2 secondes
            setTimeout(() => {
                closePasswordModal();
            }, 2000);
        }
        
        // ==========================================
        // INITIALISATION
        // ==========================================
        
        function initApp() {
            loadMembres();
            loadPresenceData();
            renderTable();
            updateStats();
            loadNightMode();
        }
        
        checkAuth();
    </script>
</body>
</html>
